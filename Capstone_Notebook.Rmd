---
title: 'Google Data Analytics Capstone: Cyclistic Analysis'
author: "By Andr√©s Rojas"
output:
  html_document:
    toc: yes
    fig_height: 3
---

# Introduction

The following case study is the final project in the [Google Data Analytics Professional Certificate](https://www.coursera.org/professional-certificates/google-data-analytics). The goal is to perform real-world tasks of a junior data analyst, and follow all the steps in the data analysis process that were taught throughout the courses. In this case study, I will simulate the role of a junior data analyst working in the marketing analyst team at Cyclistic, a bike-share company in Chicago.

## About the Company

Cyclistic is a bike-share company based in Chicago. It launched in 2016 with a fleet of 5,824 bicycles within a network of 692 stations across the city. The service provided by the company allows its customers to unlock the bikes in one station and return them to other stations in the system.

To ensure that Cyclistic fulfills the different needs of their potential customers, they offer three different pricing plans: single-ride passes, full-day passes, and annual memberships. Customers who purchase the first two plans are referred to as 'casual riders', and customers who purchase the latter are 'Cyclistic members'.

## The Scenario

After quite some time, the finance analysts have concluded that the annual members are much more profitable than casual riders. For this reason, Lily Moreno (director of marketing) believes that the next marketing tactics should focus on maximizing the number of annual members. However, she argues that Cyclistic should not target new customers, but instead convert 'casual riders' into annual members.

#### Business Task

The main task of the junior data analyst is to identify trends in the historical bike trip data of the company and establish the differences between the annual members and the casual riders. The potential findings will guide the future marketing program.

#### Key Stakeholders

* **Lily Moreno**: Director of Marketing and responsible for the developments of campaigns
* **Marketing Analytics Team**: A team of data analysts who are responsible for collecting, analyzing, and reporting data that helps guide Cyclistic marketing strategy.
* **Executive Team**: They are responsible for the approval of the recommended marketing campaigns

## About the Data

The Cyclistic's historical trip data is provided by Motivate Inc. and uploaded every month in an online repository as a public dataset. There is a .csv file for each month since 2015, and each file tracks every single ride during that month. The variables included in this database are:

* ride_id
* rideable_type
* started_at / ended_at
* start_station_name / start_station_id
* end_station_name / end_station_id
* start_lat / start_lng
* end_lat / end_lng
* member_casual

Due to data-privacy issues, there is no information about the customers' credit card numbers (hence, it is not possible to determine the geolocation of the purchase). For the purpose of this case study, only the last 12 months of the historical trip data were used (December 2020 to November 2021). This is a very good aspect of the data because it shows that it is current and still relevant.

The only clear limitation of this dataset is that about 20% of the observations do not have any record about the start or end stations, so these missing values will not allow to identify the corresponding routes of these rides. Furthermore, since there is no more information about how each observation is recorded (automatic or manual data-entry), it is not possible to examine any potential bias. This problem could happen, for example, if each customer has to record manually the names of the station where the ride starts or ends, and for some reason a specific group with the same characteristics does not record this information.

# Data Processing

For this case study, the processing stage is performed in RStudio, which seems to be a proper tool to handle the large files included in the dataset. However, it is important to notice that the same process could be done with other tools like BigQuery (using SQL) or in other statistical packages like Stata.

#### Data Collection and Merging
The fist step is to load the libraries used in the cleaning process. In this case, the ones that are used are **tidyverse, lubridate, dplyr and ggplot2**.

```{r libraries 1, include=FALSE}
library(tidyverse)
library(lubridate)
library(dplyr)
library(ggplot2)
```

Then, it is necessary to load each data set per month with the `read_csv` function, which will create 12 different data frames in the environment. However, to perform further transformations, it is important to merge all of these into a single large data frame, in order to avoid repeating the same process for each month. 

```{r Upload Dataset, include=FALSE}
data_2020_12 <- read_csv("202012-divvy-tripdata.csv")
data_2021_1 <- read_csv("202101-divvy-tripdata.csv")
data_2021_2 <- read_csv("202102-divvy-tripdata.csv")
data_2021_3 <- read_csv("202103-divvy-tripdata.csv")
data_2021_4 <- read_csv("202104-divvy-tripdata.csv")
data_2021_5 <- read_csv("202105-divvy-tripdata.csv")
data_2021_6 <- read_csv("202106-divvy-tripdata.csv")
data_2021_7 <- read_csv("202107-divvy-tripdata.csv")
data_2021_8 <- read_csv("202108-divvy-tripdata.csv")
data_2021_9 <- read_csv("202109-divvy-tripdata.csv")
data_2021_10 <- read_csv("202110-divvy-tripdata.csv")
data_2021_11 <- read_csv("202111-divvy-tripdata.csv")

all_trips <- bind_rows(data_2020_12)

for (i in 1:11) {
  df_index <- paste0('data_2021_',i)
  df <- get(df_index)
  all_trips <- bind_rows(all_trips,df)
}
rm(df)
```

```{r Trips.v1 Glimpse, echo=FALSE}
glimpse(all_trips)
```

#### Checking of Missing Values
After the creation of this single data frame (called `all_trips`), it is recommended to check for missing values in order to verify if any further analysis is possible.

```{r Missing Values 1, include=FALSE}
missing_val <- all_trips %>%
  sapply(function(x) sum(is.na(x))) %>%
  as.data.frame() %>%
  rename(., nulls = .) %>%
  mutate(col = colnames(all_trips), .before = nulls)
rownames(missing_val) <- 1:nrow(missing_val)
```

```{r Missing Values 2, echo=FALSE}
missing_val %>%     #Plots missing values for each column name
  ggplot(aes(x = nulls, y= col)) +
  geom_bar(stat = "identity", fill="#3a97d3") +
  labs(
    title = "Missing Values",
    x = NULL,
    y = "Column Names") +
  theme(
    legend.position = 'bottom',
    legend.title = element_text(size=9),
    legend.text = element_text(size=8),
    panel.background = element_rect(fill = "white"),
    plot.title = element_text(size=12, hjust = 0.5)) +
  scale_x_continuous(labels = scales::comma)
```

The results show that the columns with missing values are the ones related to the correspondent stations. However, as it was mentioned earlier, it is not possible to verify the existence of a potential bias.
Nevertheless, the main analysis is based on the other columns with no missing values, which implies that the final conclusions and recommendations of this case study will not be biased.

#### Creation of Variables
The next steps include the creation of new columns necessary for this analysis. The main variable created is `minutes_ride_length`, which represents the difference in minutes between the time of start and end of each ride. The other additions are date variables such as *month*, *year* and *day of the week*.

```{r Variables creation, include=FALSE}
all_trips$date <- as.Date(all_trips$started_at)
all_trips$month <- format(as.Date(all_trips$date), "%m")
all_trips$day <- format(as.Date(all_trips$date), "%d")
all_trips$year <- format(as.Date(all_trips$date), "%Y")
all_trips$day_of_week <- format(as.Date(all_trips$date), "%A")
all_trips$minutes_ride_length <- difftime(all_trips$ended_at,all_trips$started_at, units = "mins")
all_trips$minutes_ride_length <- round(as.numeric(all_trips$minutes_ride_length), digits = 2)
all_trips$rideable_type_2 <- ifelse(all_trips$rideable_type == "classic_bike", "classic_bike", 
                                ifelse((all_trips$rideable_type == "docked_bike") | (all_trips$rideable_type == "electric_bike"),"electric_bike","other"))

```

#### Removing "Bad" Data

```{r Trips.v2, include=FALSE}
filter_stations <- c("", " ", "DIVVY CASSETTE REPAIR MOBILE STATION")

all_trips_v2 <- all_trips %>%
  filter(minutes_ride_length > 0) %>%
  filter(!(start_station_name %in% filter_stations) &
         !(end_station_name %in% filter_stations))
```

The last step in this cleaning process involves dropping observations that do not match the following criteria:

* `minutes_ride_length` has to be a positive value (greater than zero)
* `start_station_name` and `end_station_name` can not be recorded as a blank space, nor they can be any of the repair stations of the company

Both of these conditions ensure that the results are consistent and reliable.

#### Final Outputs
```{r Cleaned_Output, include=FALSE}
start_station_info <- select(all_trips_v2, c(
  start_station_name, member_casual, start_lat, start_lng)) %>%
  group_by(start_station_name, member_casual, start_lat, start_lng) %>%
  summarize(number_of_rides = n(), .groups = "drop") %>%
  arrange(., desc(number_of_rides)) %>%
  slice(., 1:200)       #Top 200 start stations

all_trips_v3 <- select(all_trips_v2, -c(
  start_station_id, end_station_id,
  start_station_name, end_station_name,
  start_lat, start_lng, end_lat, end_lng, ride_id))

```

Finally, there are two separate data frames that are obtained after this cleaning process:

1. `start_station_info`: summarizes the top 200 start stations, based on the total number of rides (either by casual customers or members)
2. `all_trips_v3`: Cyclistic's cleaned trip data

```{r Cleaned Output glimpse, echo=FALSE}
glimpse(start_station_info)
glimpse(all_trips_v3)
```


# Data Analysis

```{r Analysis Libraries, include=FALSE}
library(leaflet)
library(mapview)
library(scales)

cyclistic_palette = c(
  "member" = "#31393C",
  "casual" = "#3a97d3"
)
```

The first results of the comparison between both types of customers show that the annual members have a lower average ride length than casual customers. 
This difference amounts to 20 minutes approximately, which could be an initial indicator that the purpose of the rides are also different.

```{r First Analysis, echo=FALSE}
aggregate(all_trips_v3$minutes_ride_length ~ all_trips_v3$member_casual, FUN = mean)
```

```{r Analysis Outputs, include=FALSE}
#2.3 Data by customer type and date
output1 <- all_trips_v3 %>%
  group_by(date = date(started_at), member_casual) %>%
  summarise(number_of_rides = n(),
            average_duration = mean(minutes_ride_length),
            .groups = 'drop')

#2.4 Data by customer type and weekday
output2 <- all_trips_v3 %>%
  mutate(weekday = wday(started_at,label=TRUE)) %>% #Option to replace full day of week
  group_by(member_casual, weekday) %>%
  summarise(number_of_rides = n(), 
            average_duration = mean(minutes_ride_length),
            .groups = 'drop') %>%
  arrange(member_casual, weekday)

#2.5 Data by customer type and month
output3 <- all_trips_v3 %>%
  mutate(month_of_ride = month(started_at, label = TRUE)) %>%
  group_by(member_casual, month_of_ride) %>%
  summarise(number_of_rides = n(), 
            average_duration = mean(minutes_ride_length),
            .groups = 'drop') %>%
  arrange(member_casual, month_of_ride)

#2.6 Data by customer type and ride type
output4 <- all_trips_v3 %>%
  group_by(member_casual, rideable_type_2) %>%
  summarise(number_of_rides = n(), 
            average_duration = mean(minutes_ride_length),
            .groups = 'drop') %>%
  arrange(member_casual, rideable_type_2)
```

In fact, the next couple of visualizations support this last argument. **Plot 1** shows that the number of rides by annual members were almost uniform since April 2021. The upwards trend between December 2020 and March 2021 could have happened because of the colder weather conditions and the health restrictions during the pandemic. On the other hand, **Plot 2** shows a very clear peak of the number of rides by casual members between the months with the highest temperatures in a year, while it is not the case during months like September, October or November.

```{r Plot 1, echo=FALSE}
output1 %>%
  ggplot(aes(x = date, y = number_of_rides, color = member_casual)) +
  geom_line() +
  labs(
    title = "Plot 1: Total Rides by Date",
    color = "Customer Type",
    x = NULL,
    y = "Number of Rides") +
  theme(
    legend.position = 'bottom',
    legend.title = element_text(size=9),
    legend.text = element_text(size=8),
    panel.background = element_rect(fill = "white"),
    plot.title = element_text(size=12, hjust = 0.5)) +
  scale_color_manual(values = cyclistic_palette) +
  scale_y_continuous(labels = scales::comma)
```

```{r Plot 2, echo=FALSE}
output3 %>%
  ggplot(aes(x=month_of_ride, y=number_of_rides, fill=member_casual)) +
  geom_col() +
  facet_wrap(~member_casual) +
  labs(
    title = "Plot 2: Total Rides per Month",
    fill = "Customer Type",
    x = NULL,
    y = "Number of Rides") +
  theme(
    legend.position = 'bottom',
    legend.title = element_text(size=9),
    legend.text = element_text(size=8),
    panel.background = element_rect(fill = "white"),
    plot.title = element_text(size=12, hjust = 0.5)) +
  scale_fill_manual(values = cyclistic_palette) +
  scale_y_continuous(labels = scales::comma)
```

Even more, despite the fluctuations of the number of rides that could happen due to seasonality, the evidence shows that annual members could have a more specific purpose for their rides. This argument can be inferred from the fact that their average ride length in minutes is almost uniform throughout the year (View **Plot 3**).
However, the same indicator has very different values for the casual customers, which also implies that the purpose of their rides can vary a lot (work, tourism or pleasure).

```{r Plot 3, echo=FALSE}
output3 %>%
  ggplot(aes(x=month_of_ride, y=average_duration, fill = member_casual)) +
  geom_col() +
  facet_wrap(~member_casual) +
  labs(
    title = "Plot 3: Average Ride Duration per Month",
    fill = "Customer Type",
    x = NULL,
    y = "Average Duration (minutes)") +
  theme(
    legend.position = 'bottom',
    legend.title = element_text(size=9),
    legend.text = element_text(size=8),
    panel.background = element_rect(fill = "white"),
    plot.title = element_text(size=12, hjust = 0.5)) +
  scale_fill_manual(values = cyclistic_palette) +
  scale_y_continuous(labels = scales::comma)
```

A different perspective of these results can be obtained if the analysis is based on the days of the week. **Plot 4** shows that the members are more likely to take a ride during weekdays, which does not happen during the weekends.

Moreover, for the members the average ride duration is constant throughout the week, with a very slight increase on Saturday and Sunday (View **Plot 5**). This could mean that they take these rides mainly to commute to their workplaces (or educational centers), but also that even this group is likely to take a ride just for leisure (given the fact that they do not have to pay extra for these situations). On the contrary, the numbers of casual customers are much larger during the weekends, which implies a predominance of bike rides for tourism or leisure.

```{r Plot 4, echo=FALSE}
output2 %>%
  ggplot(aes(x=weekday, y=number_of_rides, fill=member_casual)) +
  geom_col(position = "dodge") +
  labs(
    title = "Plot 4: Total Rides per Weekday",
    fill = "Customer Type",
    x = NULL,
    y = "Number of Rides") +
  theme(
    legend.position = 'bottom',
    legend.title = element_text(size=9),
    legend.text = element_text(size=8),
    panel.background = element_rect(fill = "white"),
    plot.title = element_text(size=12, hjust = 0.5)) +
  scale_fill_manual(values = cyclistic_palette) +
  scale_y_continuous(labels = scales::comma)
```

```{r Plot 5, echo=FALSE}
output2 %>%
  ggplot(aes(x=weekday, y=average_duration, fill=member_casual)) +
  geom_col(position = "dodge") +
  labs(
    title = "Plot 5: Average Ride Duration per Weekday",
    fill = "Customer Type",
    x = NULL,
    y = "Average Duration (minutes)") +
  theme(
    legend.position = 'bottom',
    legend.title = element_text(size=9),
    legend.text = element_text(size=8),
    panel.background = element_rect(fill = "white"),
    plot.title = element_text(size=12, hjust = 0.5)) +
  scale_fill_manual(values = cyclistic_palette) +
  scale_y_continuous(labels = scales::comma)
```

There are also clear differences on the type of bike each customer tends to choose. For example, **Plot 6** shows that casual customers do not seem to have a preference over classic or electric bikes. However, the rides on electric bikes do last longer (View **Plot 7**). This could happen because the e-bikes use always-on pedal-assist technology, so casual customers could take advantage of this feature since they seem to be more likely to take a ride for tourism or leisure. 

Annual members, on the other hand, seem to have a strong preference for classic bikes (almost 50% more rides than on electric bikes). Nevertheless, the rides average duration is almost the same for both rideable types, which again could be a strong indicator that members are more focus on commuting to their workplaces than on tourism rides.

```{r Plot 6, echo=FALSE}
output4 %>%
  ggplot(aes(x=rideable_type_2, y=number_of_rides, fill = member_casual)) +
  geom_col() +
  facet_wrap(~member_casual) +
  labs(
    title = "Plot 6: Total Rides by Rideable Type",
    fill = "Rideable Type",
    x = NULL,
    y = "Number of Rides") +
  theme(
    legend.position = 'bottom',
    legend.title = element_text(size=9),
    legend.text = element_text(size=8),
    panel.background = element_rect(fill = "white"),
    plot.title = element_text(size=12, hjust = 0.5)) +
  scale_fill_manual(values = cyclistic_palette) +
  scale_y_continuous(labels = scales::comma)
```

```{r Plot 7, echo=FALSE}
output4 %>%
  ggplot(aes(x=rideable_type_2, y=average_duration, fill = member_casual)) +
  geom_col() +
  facet_wrap(~member_casual) +
  labs(
    title = "Plot 7: Average Ride Duration by Rideable Type",
    fill = "Rideable Type",
    x = NULL,
    y = "Average Duration (minutes)") +
  theme(
    legend.position = 'bottom',
    legend.title = element_text(size=9),
    legend.text = element_text(size=8),
    panel.background = element_rect(fill = "white"),
    plot.title = element_text(size=12, hjust = 0.5)) +
  scale_fill_manual(values = cyclistic_palette) +
  scale_y_continuous(labels = scales::comma)
```

Finally, some differences can be found on the rides starting stations. The map below shows that casual customers tend to start their rides closer to the coastal area, which could be considered more attractive for tourism. As for the annual members, their starting stations are more diversified around the city.

# Conclusion

The present case study had the objective to analyze the Cyclistic's historical trip data and identify the potential differences between the annual members and casual customers. There are two main conclusions that can be obtained for each profile:

* Casual customers ride more frequently and for a longer period of time during warmer seasons. They are more active during the weekends and have a preference for e-bikes (since these allow to take longer rides more easily). Also, they tend to start from stations closer to the coast. These results suggest that casual customers are more focused on rides for leisure and tourism, but other reasons cannot be ruled out, specially during the weekdays.

* Annual members appear to take rides regularly throughout the year, with an expected slight decrease during colder months. Unlike casual customers, they are much more active during the weekdays, but do not have a preference for either rideable type. Also, the starting stations they choose are more diversified around the city, and not clustered inside a small area. The results suggest that annual members are more focused on commuting to their workplaces, but again other reasons cannot be ruled out, since the rides during the weekends are a bit longer.

Despite not being the main task for this case study, some recommendations can be proposed based on the previous conclusions to convert casual customers to annual members:

1. Identify and create campaigns for the casual customers that took a single ride just to check if Cyclistic's system works well, before committing to an annual membership. Ideally, the company could collect some feedback from their customers indicating the reason of their ride.

2. Analyze if the addition of newer stations within the city could motivate this conversion, since casual customers have a preference for e-bikes, but the latter only work with non-traditional docking stations.